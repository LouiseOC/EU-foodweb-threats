# ============================================================================ #
# ============= 3 Analyse vulnerability across Europe  ======================= #
# ============================================================================ #


### Load Packages ### 

# clean data 
library(dplyr)
library(tidyr)

# network metrics 
library(igraph)

# spatial data manipulation 
library(foreign)
library("rstudioapi")

# plots
library(pheatmap)
library(RColorBrewer)
library(ggplot2)

library(corrplot)
library(Hmisc)


source("scripts/FUN_foodwebs_threat_impact.R")

## ## ## ## ## ## ## ## ## ## ## ## ## ## ## ## ## ## ## ## ## ## ## ## ## ## ##
#----------------- 3A - Spatial vulnerability, species and links------------####
## ## ## ## ## ## ## ## ## ## ## ## ## ## ## ## ## ## ## ## ## ## ## ## ## ## ## 





source("scripts/FUN_foodwebs_threat_impact.R")
### loop for each pixel: create subset (matrix) of the food web 
library(igraph)
library(foreign)
library("rstudioapi")
library(corrplot)
library(Hmisc)

g.metaweb <- graph_from_adjacency_matrix(adjmatrix = adjm, mode = "directed")
species.names <- V(g.metaweb)$name ## 1142 species 

## Spatial data ##
load("../Data/BioticData/Distributions/maiorano2013/Spatial_distributions/MASTER.bin10000_opthab_tresh0.Rdata") # master = matrix of pixels (in rows) x species (in columns)
px_sp <- master
rm(master)
# make that the first column contains values, and rows have now row names: 
row.names(px_sp)<- px_sp$PAGENAME
px_sp$PAGENAME <- NULL


# keep only pixels in EU
load("../Data/2022_10k_pixels_in_EU.RData")
EU.pixels <- as.character(pixels.in.EU$PageName)
px_sp <- px_sp[EU.pixels, ]


# remove pixels with NAs
px_sp <- px_sp[complete.cases(px_sp), ]


# remove species that are not in study area
spp2exclude <- which(colSums(px_sp) == 0)

px_sp <- px_sp[, !names(px_sp) %in% names(spp2exclude)] # this removes 1152-804 = 358 species 
# 804 species in the study area


## threats  data #
load("data/analysisInput/tetrapod_main_threats.RData")

## restrict to intersect of species in the IUCN / EEA dataset + spatial data + metaweb 
species<- intersect(species.names, intersect(colnames(px_sp), tetrapods.main.threats.bin$sppID))
g.metaweb <- induced.subgraph(g.metaweb, V(g.metaweb)$name %in%species)
px_sp <- px_sp[,species]
### this makes 869 species

# ### alps only subset to start with
# load("../Data/BioticData/ForServane/Alpinemetaweb_and_trophicgroups.RData")
# species_alps <- intersect(colnames(px_sp_alps), species)
# px_sp_alps <- px_sp_alps[,species_alps]
# px_sp <- px_sp_alps

g.list <- create_local_foodwebs(px_sp = px_sp, g.metaweb = g.metaweb)
# save(g.list, file = "data/analysisOutput/20220719_obligate_local_graph_list_EU_10k.RData")
# ## remove empty pixels and pixels with only 1 species
# px_sp <- px_sp[rowSums(px_sp) > 1, ]

# load("data/analysisOutput/20220719_obligate_local_graph_list_EU_10k.RData")


### load major threat matrix
Major.Threats.S <- Threat.S[,c(5,29,31:34)]

## initialize spatial dataframe with summary metrics for each pixel 
threats_spatial_df <- as.data.frame(matrix(nrow = nrow(px_sp), ncol = 3+2*ncol(Major.Threats.S), data = NA))

colnames(threats_spatial_df) <- c("pixel", "Nb.species", "Nb.links",
                                  paste0("spp_thr_by_", colnames(Major.Threats.S)),
                                  paste0("links_thr_by_", colnames(Major.Threats.S)))

# each row = 1 pixel
threats_spatial_df$pixel <- rownames(px_sp)


for (i in 1:length(g.list)){
  print(i)
  # number of species in pixel i
  threats_spatial_df[i, "Nb.species"] <- gorder(g.list[[i]])
  # number of trophic interactions in pixel i 
  threats_spatial_df[i, "Nb.links"] <- gsize(g.list[[i]])
  if(gorder(g.list[[i]]) ==1){
    threats_spatial_number_df[i, -c(1:3)] <- NA
    threats_spatial_df[i, -c(1:3)] <- NA
  }
  else{
    # number and percentage of threatened species  
    localsp <- V(g.list[[i]])$name
    localspp <- intersect(localsp, rownames(Major.Threats.S))
    subset.threats.spp <- Major.Threats.S[localspp, ]
    for(j in 1:ncol(Major.Threats.S)){
      # threats_spatial_df[i, 3+j] <- colSums(subset.threats.spp)[j]/gorder(g.list[[i]]) #### to obtain a proportion 
      threats_spatial_df[i, 3+j] <- colSums(subset.threats.spp)[j] #### to obtain a number
      
    }
    # number and percentage of threatened interactions in pixel i
    ### use function  that counts number of threatened interactions (without counting the same link twice)
    ### for major threats 
    adjm_i <- as.matrix(as_adjacency_matrix(g.list[[i]]))
    sum.threatened.links <- count.threatened.interactions(adjm = adjm_i, threattable = Major.Threats.S)
    for(k in 1:ncol(Major.Threats.S)){
      threats_spatial_df[i, 3+ncol(Major.Threats.S)+k] <- sum.threatened.links[k] #### to obtain a number
    } 
  }
}

summary(threats_spatial_df)
# save(threats_spatial_df, file = "data/analysisOutput/20220719_spatial_threats_number_df_EU.RData")




## ## ## ## ## ## ## ## ## ## ## ## ## ## ## ## ## ## ## ## ## ## ## ## ## ## ##
#----------------- 3B - BoxPlot spatial ------------------------------------####
## ## ## ## ## ## ## ## ## ## ## ## ## ## ## ## ## ## ## ## ## ## ## ## ## ## ##

# load("data/analysisOutput/20220719_spatial_threats_number_df_EU.RData")


threats_spatial_prop_df <- threats_spatial_df
colnames(Major.Threats.S)

### transform each value to raster 
mask.dir <- "../Data/BioticData/Distributions/maiorano2013/Spp_spatial_Distributions/10k/mask/"

for(i in 1:ncol(threats_spatial_prop_df)-1){
  dbf_i <- threats_spatial_prop_df[, c(1, 1+i)] # 2 columns: pixel name + variable to plot
  
  raster_i <- fun.dbf2raster(SPPPA = dbf_i, mask.dir = mask.dir)
  
  writeRaster(raster_i, filename = paste0("data/rasterOUT/EU_", gsub("\\.", "_", colnames(threats_spatial_prop_df)[1+i]), ".tif"), overwrite = T)
  
}



### Hotspots- Fig 6 #####
### 1 map per threat: normalize & multiply species & links to see areas of hotspots

## scale THE PROPORTIONS between 0 and 1 then multiply links x species 
threats_spatial_prop_df <- threats_spatial_prop_df[complete.cases(threats_spatial_prop_df),]
threats_spatial_df_01 <-threats_spatial_prop_df

## divide by max value 
for (i in 4:17){
  m <- max(threats_spatial_df_01[, i])
  threats_spatial_df_01[, i] <- threats_spatial_df_01[, i]/m
}

## 
threats_spatial_df_combine <- threats_spatial_df_01 %>%
  mutate(multiply.climate = spp_thr_by_ClimateChange * links_thr_by_ClimateChange) %>%
  mutate(multiply.agri = spp_thr_by_Agriculture * links_thr_by_Agriculture) %>%
  mutate(multiply.hunting = spp_thr_by_Hunting.Persecution * links_thr_by_Hunting.Persecution) %>%
  mutate(multiply.pollution = spp_thr_by_Pollution * links_thr_by_Pollution) %>%
  mutate(multiply.IAS = spp_thr_by_IAS.Diseases * links_thr_by_IAS.Diseases) %>%
  mutate(multiply.urbanisation = spp_thr_by_Artificialization * links_thr_by_Artificialization) 


threats_spatial_df_combine <- threats_spatial_df_combine[, -c(2:17)]

for(i in 2:ncol(threats_spatial_df_combine)){
  dbf_i <- threats_spatial_df_combine[, c(1, i)] # 2 columns: pixel name + variable to plot
  
  raster_i <- fun.dbf2raster(SPPPA = dbf_i, mask.dir = mask.dir)
  
  writeRaster(raster_i, filename = paste0("data/rasterOUT/PROP", gsub("\\.", "_", colnames(threats_spatial_df_combine)[i]), ".tif"), overwrite = T)
  
}



### boxplot - fig 5 #### 
### vulnerable species, vulnerable links in food webs across Europe 


# proportion species threatened 
for (i in 4:10){
  threats_spatial_prop_df[, i] <- threats_spatial_df[, i]/threats_spatial_df$Nb.species
}

# proportion links threatened 
for (i in (11:17)){
  threats_spatial_prop_df[, i] <- threats_spatial_df[, i]/threats_spatial_df$Nb.links
}

## long format 
threats_spatial_prop_df_long_links <- gather(threats_spatial_prop_df[, -c(2:10)], key = threat, value = proportion, -"pixel")
threats_spatial_prop_df_long_spp <- gather(threats_spatial_prop_df[, -c(2:3, 11:17)], key = threat, value = proportion, -"pixel")
threats_spatial_prop_df_long_spp$type <- "species"
threats_spatial_prop_df_long_links$type <- "links"

threats_spatial_prop_df_long_spp$threat <- gsub("spp_thr_by_", "",threats_spatial_prop_df_long_spp$threat )
threats_spatial_prop_df_long_links$threat <- gsub("links_thr_by_", "",threats_spatial_prop_df_long_spp$threat )


# rm mining 
threats_spatial_prop_df_long_spp <- subset(threats_spatial_prop_df_long_spp, threat != "Mining.EnergyProduction")
threats_spatial_prop_df_long_links <- subset(threats_spatial_prop_df_long_links, threat != "Mining.EnergyProduction")


threats_spatial_prop_df_long_spp$threat <- factor(threats_spatial_prop_df_long_spp$threat, 
                                                  levels = c("Hunting.Persecution", 
                                                             "Agriculture",  
                                                             "ClimateChange",
                                                             "Pollution",
                                                             "Artificialization",
                                                             "IAS.Diseases", 
                                                             "Mining.EnergyProduction"))
threats_spatial_prop_df_long_links$threat <- factor(threats_spatial_prop_df_long_links$threat, 
                                                    levels = c("Hunting.Persecution", 
                                                               "Agriculture",  
                                                               "ClimateChange",
                                                               "Pollution",
                                                               "Artificialization",
                                                               "IAS.Diseases", 
                                                               "Mining.EnergyProduction"))
## ggplot old (jitter)
# ggplot(data = threats_spatial_prop_df_long_spp, aes(y = proportion, x = threat))+
#   geom_jitter(position=position_jitter(0.25), aes(colour = threat), alpha = 0.015)+
#   geom_boxplot(width = 0.4, alpha = 0.5)+
#   ylim(0, 1)+
#   theme_minimal()
# 
# ggbox_spatial_links <- ggplot(data = threats_spatial_prop_df_long_links, aes(y = proportion, x = threat))+
#   geom_jitter(position=position_jitter(0.25), aes(colour = threat), alpha = 0.015)+
#   geom_boxplot(width = 0.4, alpha = 0.5)+
#   ylim(0, 1)+
#   theme_minimal()

## violin plot (better vis)

library(ghibli)

ggplot(data = threats_spatial_prop_df_long_spp, aes(y = proportion, x = threat))+
  geom_violin(width=1, aes(fill = threat), colour = "gray20", lwd = 0.2) +
  geom_boxplot(width=0.15, color="grey", alpha=0.2, outlier.alpha = 0.1, outlier.size = 0.1) +
  ylim(0, 1)+
  scale_fill_ghibli_d("PonyoMedium", direction = 1)+
  theme_minimal()

ggplot(data = threats_spatial_prop_df_long_links, aes(y = proportion, x = threat))+
  geom_violin(width=1, aes(fill = threat), colour = "gray20", lwd = 0.2) +
  geom_boxplot(width=0.15, color="grey", alpha=0.2, outlier.alpha = 0.1, outlier.size = 0.1) +
  scale_fill_ghibli_d("PonyoMedium", direction = 1)+
  ylim(0, 1)+
  theme_minimal()






### mean and confidence intervals #####

# aggregate to compute mean 
spatial_threats_links <- aggregate(proportion ~ threat +type, data = threats_spatial_prop_df_long_links, mean)

spatial_threats_spp <- aggregate(proportion ~ threat + type, data = threats_spatial_prop_df_long_spp, mean)


spatial_threats_aggr <- rbind(spatial_threats_links, spatial_threats_spp) 
spatial_threats_aggr$CI_lower <- NA
spatial_threats_aggr$CI_upper <- NA

# Loop over each variable ## can only do this for major threats because enough species are concerned 
for (i in 1:nrow(spatial_threats_aggr)){
  t <- as.character(spatial_threats_aggr$threat[i])
  # links 
  data_links <- subset(threats_spatial_prop_df_long_links, threats_spatial_prop_df_long_links$threat == t)
  # calc ci 
  ci <- t.test(data_links$proportion)$conf.int
  # add to the data frame
  spatial_threats_aggr[which(spatial_threats_aggr$threat == t & spatial_threats_aggr$type == "links") , ]$CI_lower <- ci[1]
  spatial_threats_aggr[which(spatial_threats_aggr$threat == t & spatial_threats_aggr$type == "links"), ]$CI_upper <- ci[2]
  
  
  # species 
  data_spp <- subset(threats_spatial_prop_df_long_spp, threats_spatial_prop_df_long_spp$threat == t)    
  # calc ci 
  ci <- t.test(data_spp$proportion)$conf.int
  # add to the data frame
  spatial_threats_aggr[which(spatial_threats_aggr$threat == t & spatial_threats_aggr$type == "species") , ]$CI_lower <- ci[1]
  spatial_threats_aggr[which(spatial_threats_aggr$threat == t & spatial_threats_aggr$type == "species"), ]$CI_upper <- ci[2]
  
}





