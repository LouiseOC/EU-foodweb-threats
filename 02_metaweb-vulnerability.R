# ============================================================================ #
# =========== 2. Analyse threats at the metaweb level ======================== #
# ============================================================================ #
### Load Packages ### 

# clean data 
library(dplyr)
library(tidyr)

# network metrics 
library(igraph)

# spatial data manipulation 
library(foreign)
library("rstudioapi")

# plots
library(pheatmap)
library(RColorBrewer)
library(ggplot2)

library(corrplot)
library(Hmisc)


source("scripts/FUN_foodwebs_threat_impact.R")


## ## ## ## ## ## ## ## ## ## ## ## ## ## ## ## ## ## ## ## ## ## ## ## ## ## ##
#----------------- 2A - Quantify threats x interactions   ------------------####
## ## ## ## ## ## ## ## ## ## ## ## ## ## ## ## ## ## ## ## ## ## ## ## ## ## ##




threats.spp <- tetrapods.threats.bin
rownames(threats.spp) <- threats.spp$sppID
colnames(threats.spp)




### Load Metaweb 
load("data/2022_obligate_cooccur_BARM_Adult.Rdata")

adjm <- BARM_filtered_co
### this metaweb is in the format  (predator, prey) i.e. if element (i,j) = 1, then species in row i eats species in column j)
sum(adjm)## number of links in the filtered metaweb 
dim(adjm)

### combine metaweb and threat matrices ####

### match species order in both matrices
matching.sps <- intersect(rownames(adjm), threats.spp$sppID) # 888 species


### align datasets in same species names and order ## 
adjm <- adjm[matching.sps, matching.sps] 

### threats x species matrix 
rownames(threats.spp) ## must be sppID
colnames(threats.spp)
Threat.S <- threats.spp[matching.sps, -c(1:6)] ## remove taxonomic info to transform to matrix 

Threat.S <- as.matrix(Threat.S) ## species, threats
M <- as.matrix(adjm) ## predators, prey 
diag(M) <- 0 ## remove cannibalism




### threatened interactions ####
source('scripts/FUN_foodwebs_threat_impact.R')

# directly threatened species
direct.threats.spp <- colSums(Threat.S)

## count threatened interactions without double counting if both prey and predator and threatened 
interactions.threatened <- count.threatened.interactions(threattable = Threat.S, adjm= M)

interactions_threats <- data.frame(threat = names(interactions.threatened), 
                                   direct.spp =direct.threats.spp, 
                                   # prop.species.threatened = direct.threats.spp/nspecies,
                                   # indirect.predators = sum.indirect.only, 
                                   # indirect.prey = sum.prey.only, 
                                   interactions.thr = interactions.threatened)
# note: prop.interactions.thr = interactions.threatened/totalinteractions

### barplot ####

nspecies <- ncol(M)

ggspecies.direct <- ggplot(interactions_threats, aes(x = reorder(threat,-direct.spp), y = direct.spp/nspecies*100))+ 
  geom_bar(stat = "identity", width = 0.5, fill = 'gray10')+
  ylim(0, 100)+
  xlab(label = "Threat type")+
  theme_minimal()+
  theme(axis.text.x = element_text(angle= 90, hjust = 0), 
        axis.text.y = element_text(  angle= 90))

totalinteractions <- sum(M)
ggspecies.interactions <- ggplot(interactions_threats, aes(x = reorder(threat,-direct.spp), y = interactions.thr/totalinteractions*100))+ 
  geom_bar(stat = "identity", width = 0.5, fill ='gray50')+
  ylim(0, 100)+
  xlab(label = "Threat type")+
  theme_minimal()+
  theme(axis.text.x = element_text(angle= 90, hjust = 0), 
        axis.text.y = element_text(  angle= 90))


interactions_threats$direct.spp <- interactions_threats$direct.spp/nspecies
interactions_threats$interactions.thr <- interactions_threats$interactions.thr/totalinteractions






## ## ## ## ## ## ## ## ## ## ## ## ## ## ## ## ## ## ## ## ## ## ## ## ## ## ##
#--------------- 2B - Threats x Trophic groups ---------------------------#####
## ## ## ## ## ## ## ## ## ## ## ## ## ## ## ## ## ## ## ## ## ## ## ## ## ## ##





### how many species in each trophic group are affected by which threats? 

### load species x trophic groups table 
load("data/SBMgroups_species.RData")
sppxgroups$sppID <- NULL

groupsize <- colSums(sppxgroups)
groups_size <- data.frame(groupID = names(groupsize), 
                          size = groupsize)

groups_size <- subset(groups_size,size !=0)

matching.sps <- intersect(rownames(sppxgroups), rownames(Threat.S))

Threat.S <- Threat.S[matching.sps, ]
# get species in rows in same order 
Spp.Groups <- sppxgroups[matching.sps, ]

# convert to matrix
Spp.Groups <- as.matrix(Spp.Groups) 
# species.subsubset <- intersect(rownames(Spp.Groups), rownames(Threat.S))
# Spp.Groups <- Spp.Groups[species.subsubset, ]
# Threat.S <- Threat.S[species.subsubset, ]

Groups.Threats <- t(Spp.Groups) %*% Threat.S
Groups.Threats.propsize <- Groups.Threats
for (i in 1:ncol(Groups.Threats.propsize)){
  Groups.Threats.propsize[, i] <- Groups.Threats[, i]/groupsize
}


# remove na rows = diets groups 
Groups.Threats.propsize <-Groups.Threats.propsize[complete.cases(Groups.Threats.propsize),]

# Create 2 matrices for minor and major threats to plot separately 
colnames(Groups.Threats.propsize)
groups.minor.threats <- Groups.Threats.propsize[ , c(1:28)]
Groups.Main.Threats <- Groups.Threats.propsize[ , c(5, 8, 29:35 )] ## including fishing




### heatmap ####
pheatmap(groups.minor.threats, 
         display_numbers = T, 
         cluster_cols = F,
         cluster_rows = F, 
         color =colorRampPalette(brewer.pal(n = 7, name ="Reds"))(100),
         # cluster_cols = F, cluster_rows = F, 
         # main = paste0("Proportion spatial overlap between top ", (1-topX)*100,"% priorities\n of different Zruns \n", Zsettings), 
         # fontsize_number = 20, 
         number_color = "gray10", 
         # filename = paste0("Processed/heatmap_spatialoverlap_top", (1- topX)*100, Zsettings, ".pdf"),
         angle_col = 315)


pheatmap(Groups.Main.Threats, 
         display_numbers = T, 
         cluster_cols = F,
         cluster_rows = F, 
         color =colorRampPalette(brewer.pal(n = 7, name ="Reds"))(100),
         # cluster_cols = F, cluster_rows = F, 
         # main = paste0("Proportion spatial overlap between top ", (1-topX)*100,"% priorities\n of different Zruns \n", Zsettings), 
         # fontsize_number = 20, 
         number_color = "gray10", 
         # filename = paste0("Processed/heatmap_spatialoverlap_top", (1- topX)*100, Zsettings, ".pdf"),
         angle_col = 315)



#### NOTE that there are only 25 groups (instead of 28 as in the SBM output) 
####      because 3 of these groups are made of diet categories ONLY


# ### export for Gephi ####
### main threats x SBM groups ##
# ### agriculture, hunting & persecution, pollution, artificialisation, IAS/Diseases, energy production 
# ### export this as nodes tables to add to the SBM groups network
# ### then represent proportion species affected per group with colour intensity. 
# threats.groups4Gephi <- as.data.frame(Groups.AllThreats.propsize)
# threats.groups4Gephi$Id <- rownames(threats.groups4Gephi)
# threats.groups4Gephi$Label <- rownames(threats.groups4Gephi)
# 
# 
# groups_size$Id <- groups_size$groupID
# groups_size$Label <- groups_size$groupID
# 
# write.csv(threats.groups4Gephi, file = "data/analysisInput/ForGephi_threats_NEWgroups_nodetable.csv", row.names = F)
# write.csv(groups_size, file = "data/analysisInput/ForGephi_NEWgroups_size.csv", row.names = F)






# ============================================================================ #
# ============================================================================ #
# ============================================================================ #



## ## ## ## ## ## ## ## ## ## ## ## ## ## ## ## ## ## ## ## ## ## ## ## ## ## ##
#----------------- 2C - Analyse in/out degree x threats   ------------------####
## ## ## ## ## ## ## ## ## ## ## ## ## ## ## ## ## ## ## ## ## ## ## ## ## ## ##



## in/out degree boxplot jitter

### this metaweb is in the format  (predator, prey) i.e. if element (i,j) = 1, then species in row i eats species in column j)
dim(adjm)
g.metaweb <- graph_from_adjacency_matrix(adjm, mode = "directed")

#compute in and out degree of species in the new metaweb 
deg.out <- degree(g.metaweb, mode = "out") # number of prey
deg.in <- degree(g.metaweb, mode = "in") # number of predators
deg.all <- degree(g.metaweb, mode = "total")

# data frame with degree & threats faced by each species 
spp_degree_threats <- data.frame(species = names(deg.out), ## spp.id
                                 nprey = deg.out, ## value of degree
                                 npreds = deg.in, 
                                 degree = deg.all) 

## make threats x degree dataframe

colnames(threats.spp)

matching.sps <- intersect(colnames(adjm), threats.spp$sppID)


# transform to long format 
Threats_long <- gather(threats.spp[, -c(1:5)], key = threat, value = bin, -sppID)
Threats_long <- subset(Threats_long, sppID %in% matching.sps)
Threats_long <- subset(Threats_long, Threats_long$bin == 1)

## add degree information
Threats_long$nprey <- spp_degree_threats$nprey[match(Threats_long$sppID, spp_degree_threats$species)]
Threats_long$npred <- spp_degree_threats$npreds[match(Threats_long$sppID, spp_degree_threats$species)]

## then gather in.degree and out.degree into 2 columns: degree (value) and in.out (2 levels, type of degree, for ggplot)     
Threats_long$bin <- NULL


Threats_long$total <- spp_degree_threats$degree[match(Threats_long$sppID, spp_degree_threats$species)]
Threats_long <- gather(Threats_long, key = type, value = degree, -c(sppID, threat))

Threats_long$type <- factor(Threats_long$type, 
                            levels = c("total", "nprey", "npred" ))

## make figure with major threats and minor threats (for supp figure)
unique(Threats_long$threat)

Major.Threat.types <- c("Direct.Exploitation", 
                        "Agriculture",
                        "Climate.Change", 
                        "Pollution",
                        "Urbanisation",
                        "IAS.Diseases")

sub.threat.types <- unique(Threats_long$threat)[1:28]


## reorder factor levels 
Threats_long$threat <- factor(Threats_long$threat, 
                              levels = c(Major.Threat.types, sub.threat.types[-5]))


#### ggplot ####

ghibli_palettes$MarnieLight1

ggplot(data = subset(Threats_long, threat %in% Major.Threat.types), aes(y = degree, x = threat, fill = type))+
  geom_boxplot(width = 0.6, colour = 'gray60', lwd = 0.2, outlier.size = 0.7)+
  scale_fill_manual(values = c("#274637FF", "#2C715FFF", "#44A57CFF"))+
  # scale_fill_manual(values = c("#7570b3", "#d95f02", "#1b9e77"))+
  # geom_jitter(alpha = 0.18, aes(colour = type))+
  theme_minimal() + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) + 
  scale_y_continuous(trans = "pseudo_log")





# fig2_bis <- ggplot(data = subset(Threats_long, threat %in% Major.Threat.types), aes(y = degree, x = type, fill = threat))+
#   geom_boxplot(width = 0.65)+
#   # scale_fill_manual(values = c("#7570b3", "#d95f02", "#1b9e77"))+
#   # geom_jitter(alpha = 0.18, aes(colour = type))+
#   theme_minimal() + 
#   theme(axis.text.x = element_text(angle = 45, hjust = 1)) + 
#   scale_y_continuous(trans = "pseudo_log")


supp_fig_deg <- ggplot(data = subset(Threats_long, threat %in% sub.threat.types[-5]), aes(y = degree, x = threat, fill = type))+
  geom_boxplot(width = 0.6, lwd = 0.4, outlier.size = 0.5)+
  scale_fill_manual(values = c("#7570b3", "#d95f02", "#1b9e77"))+
  # geom_jitter(alpha = 0.18, aes(colour = type))+
  theme_minimal() + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) + 
  scale_y_continuous(trans = "pseudo_log")


#### mean & confidence intervals ####

## calculate confidence intervals for mean in/out degree across all threats  ### 
# aggregate to calculate mean degree (total, in, out) for each threat type 
threats_degree_aggr <- aggregate(degree ~ threat + type, data = Threats_long, mean)

threats_degree_aggr$CI_lower <- NA
threats_degree_aggr$CI_upper <- NA

# Loop over each variable ## can only do this for major threats because enough species are concerned 
for (i in 1:length(union(Major.Threat.types, sub.threat.types))){
  t <- union(Major.Threat.types, sub.threat.types)[i]
  data <- subset(Threats_long, Threats_long$threat == t)
  for(deg.type in c('total', 'nprey', 'npred')){
    # calc ci 
    ci <- t.test(data[which(data$type == deg.type), ]$degree)$conf.int
    # add to the data frame
    threats_degree_aggr[which(threats_degree_aggr$threat == t & threats_degree_aggr$type == deg.type), ]$CI_lower <- ci[1]
    threats_degree_aggr[which(threats_degree_aggr$threat == t & threats_degree_aggr$type == deg.type), ]$CI_upper <- ci[2]
    
  }
}




# ============================================================================ #
# ============================================================================ #
# ============================================================================ #



## ## ## ## ## ## ## ## ## ## ## ## ## ## ## ## ## ## ## ## ## ## ## ## ## ## ##
#----------------- 2D -  Indirect threats to predators ---------------------####
## ## ## ## ## ## ## ## ## ## ## ## ## ## ## ## ## ## ## ## ## ## ## ## ## ## ## 




### multiply M x TS 
# prey->predator links that are threatened because of threats to prey
P <- M %*% Threat.S ### in this matrix, each element is the number of prey species of predator in row affected by threat in column
colSums(P)

# predator-> prey links that are threatened because of threats to predator
PP <- t(M) %*% Threat.S
colSums(PP)



### PERCENTAGE PREY PER PREDATOR THAT ARE THREATENED (EN, VU, CR) ###
# tetrapods.main.threats.bin$euRegionalRedListCategory <- as.factor(tetrapods.main.threats.bin$euRegionalRedListCategory)
tetrapods.main.threats.bin$europeanRegionalRedListCategory <- as.factor(tetrapods.main.threats.bin$europeanRegionalRedListCategory)

# summary(tetrapods.main.threats.bin$euRegionalRedListCategory) ### in the eu assessment, many species are NE = Not Evaluated. 
summary(tetrapods.main.threats.bin$europeanRegionalRedListCategory) ### this is our study area anyway 


## Build species matrix to summarize direct threat status, with number of direct threats, major threats, and conservation status. 
species.threats.summary <- data.frame(sppID = tetrapods.main.threats.bin$sppID, 
                                      RedList.threatened = ifelse(tetrapods.main.threats.bin$europeanRegionalRedListCategory %in% c("CR", "EN", "VU"), 1, 0), 
                                      CR = ifelse(tetrapods.main.threats.bin$europeanRegionalRedListCategory == "CR", 1, 0), 
                                      EN = ifelse(tetrapods.main.threats.bin$europeanRegionalRedListCategory == "EN", 1, 0), 
                                      VU = ifelse(tetrapods.main.threats.bin$europeanRegionalRedListCategory == "VU", 1, 0),
                                      sum.majorthreats = rowSums(tetrapods.main.threats.bin[,55:61])) 

species.threats.summary$atleast1majorthreat.bin <- ifelse(species.threats.summary$sum.majorthreats>=1, 1, 0)

species.threats.summary[is.na(species.threats.summary)] <- 0

colSums(tetrapods.main.threats.bin[,18:61])
colnames(tetrapods.main.threats.bin)

species.threats.summary <- cbind(species.threats.summary, tetrapods.main.threats.bin[,c(18,19,21,24:29, 38:40,48, 49,55:61)])
rownames(species.threats.summary) <- species.threats.summary$sppID


### reorder species to get same order as the metaweb prey species 
species.threats.summary <- species.threats.summary[colnames(M),]
colnames(species.threats.summary)

Sp.directThr <- as.matrix(species.threats.summary[, -c(1,6)])
### matrix multiplication 
prey.threats.per.predator <- M %*% Sp.directThr  ### number of prey per predator that is concerned by each column

#### PERCENTAGE THREATENED PREY PER PREDATOR, PER THREAT TYPE ######
nprey <- rowSums(M)
nprey <- nprey[rownames(prey.threats.per.predator)] ## make sure order is correct
#remove species with no prey
predators <- names(nprey[which(nprey!=0)])
P.percent.prey<- prey.threats.per.predator[predators, ]
nprey <- nprey[predators]

### for each predator (in row) compute percentage of prey species affected by each threat,
for(j in 1:ncol(P.percent.prey)){
  P.percent.prey[, j] <- prey.threats.per.predator[predators, j]/nprey * 100
}

### summary statistics!
summary(P.percent.prey)


### plot as boxplot + jitter points for each predator species and each threat. 
percent.prey.threats <- as.data.frame(P.percent.prey)
# summary(percent.prey.threats)

### how many species have 100% of their prey that is affected by at least 1 major threat? 
# percent.prey.threats$Id[which(percent.prey.threats$prey_atleast1majorthreat.bin ==100)]
# ggplot(data = percent.prey.threats, aes(x= prey_atleast1majorthreat.bin))+
#   geom_histogram(binwidth=1, colour='black', fill = "gray80", )


percent.prey.threats$SppID <- rownames(percent.prey.threats)

percent.prey.threats.long <- gather(percent.prey.threats[, c(20:25, 29)], key = Threat_type, value = percent_prey, -SppID)
percent.prey.threats.long$Threat_type <- as.factor(percent.prey.threats.long$Threat_type)

percent.prey.threats.long$Threat_type <- gsub("prey_", "", percent.prey.threats.long$Threat_type )

percent.prey.threats.long$Threat_type <-factor(percent.prey.threats.long$Threat_type , 
                                               levels = c("Hunting.Persecution",
                                                          "Agriculture",  
                                                          "ClimateChange",
                                                          "Pollution",
                                                          "Artificialization",
                                                          "IAS.Diseases", ))


#### FIGURE BOXPLOT ####
ggplot(data = percent.prey.threats.long, aes(y = percent_prey, x = Threat_type))+
  geom_boxplot(width = 0.6, aes(colour = Threat_type), fill = "gray95")+
  scale_color_ghibli_d("PonyoMedium", direction = 1)+
  geom_jitter(position=position_jitter(0.3), aes(colour = Threat_type), alpha = 0.3)+
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  theme_minimal()





#### supp figure: with subcategories 
percent.prey.subthreats.long <- gather(percent.prey.threats[, c(6:19, 29)], key = Threat_type, value = percent_prey, -SppID)
percent.prey.subthreats.long$Threat_type <- as.factor(percent.prey.subthreats.long$Threat_type)

percent.prey.subthreats.long$Threat_type <- gsub("prey_", "", percent.prey.subthreats.long$Threat_type )
percent.prey.subthreats.long$Threat_type <- gsub("urbanisation", "housing", percent.prey.subthreats.long$Threat_type )

percent.prey.subthreats.long$Threat_type <-factor(percent.prey.subthreats.long$Threat_type , 
                                                  levels = gsub("prey_", "", colnames(percent.prey.threats[, c(6:19)])))




ghibli_palettes$PonyoMedium

ggplot(data = percent.prey.subthreats.long, aes(y = percent_prey, x = Threat_type))+
  geom_boxplot(width = 0.6, aes(colour = Threat_type), fill = "gray95")+
  # scale_color_ghibli_d("PonyoMedium", direction = 1)+
  geom_jitter(position=position_jitter(0.3), aes(colour = Threat_type), alpha = 0.3)+
  theme_minimal()+ 
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) 




#### mean & confidence interval #### 

# convert to long format 
percent.prey.threats_long <- gather(percent.prey.threats[, c(20:27)], key = threat, value = percent_thr_prey, -Id)
percent.prey.threats_long$threat <- gsub("prey_", "", percent.prey.threats_long$threat)

# aggregate to compute mean 
threats_preds_aggr <- aggregate(percent_thr_prey ~ threat, data = percent.prey.threats_long, mean)

threats_preds_aggr$CI_lower <- NA
threats_preds_aggr$CI_upper <- NA

# Loop over each variable ## can only do this for major threats because enough species are concerned 
for (i in 1:nrow(threats_preds_aggr)){
  t <- threats_preds_aggr$threat[i]
  data <- subset(percent.prey.threats_long, percent.prey.threats_long$threat == t)
  # calc ci 
  ci <- t.test(data$percent_thr_prey)$conf.int
  # add to the data frame
  threats_preds_aggr[which(threats_preds_aggr$threat == t) , ]$CI_lower <- ci[1]
  threats_preds_aggr[which(threats_preds_aggr$threat == t), ]$CI_upper <- ci[2]
}


